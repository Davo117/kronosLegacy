<?php

  include '../../datos/mysql.php';	
  require('../../fpdf/fpdflbl.php');

  $link = conectar();

  if ($_GET['fchprograma'])
  { // Etiquetas por programaci贸n
    $packingListSelect = $link->query("
      SELECT proglote.lote,
             proglote.tarima,
             proglote.idlote,
             prodlote.serie,
             prodlote.noop,
             proglote.longitud,
             pdtosustrato.anchura,
             proglote.peso,
           ((prodloteope.longin*pdtojuego.alpaso)/pdtojuego.altura) AS cantidad,
             pdtoimpresion.idimpresion,
             pdtoimpresion.impresion,
             pdtodiseno.diseno,
             pdtoimpresion.anchof,
             pdtoimpresion.empalme,
             pdtojuego.registro,
             pdtojuego.alpaso,
             prodlote.cdglote
        FROM progbloque,
             proglote,
             prodlote,
             prodloteope,
             pdtodiseno, 
             pdtoimpresion,
             pdtojuego,
             pdtosustrato
      WHERE (pdtosustrato.cdgsustrato = progbloque.cdgsustrato AND
             progbloque.cdgbloque = proglote.cdgbloque AND
             proglote.cdglote = prodlote.cdglote AND
             prodlote.cdglote = prodloteope.cdglote AND 
             prodloteope.cdgoperacion = '10001') AND 
            (prodlote.cdgproducto = pdtoimpresion.cdgimpresion AND
             pdtoimpresion.cdgdiseno = pdtodiseno.cdgdiseno) AND
            (prodloteope.cdgjuego = pdtojuego.cdgjuego AND
             pdtojuego.cdgimpresion = pdtoimpresion.cdgimpresion) AND
            (prodlote.cdgproducto = '".$_GET['cdgproducto']."' AND
             prodloteope.cdgjuego = '".$_GET['cdgjuego']."' AND
             prodloteope.cdgmaquina = '".$_GET['cdgmaquina']."' AND
             prodlote.fchprograma = '".$_GET['fchprograma']."' AND
             prodlote.sttlote = 'A')"); 
  } else
  { if ($_GET['sttlote'] == 'A')
    { // Etiquetas por producto y estatus
      $packingListSelect = $link->query("
        SELECT proglote.lote,
               proglote.tarima,
               proglote.idlote,
               prodlote.serie,
               prodlote.noop,
               proglote.longitud,
               pdtosustrato.anchura,
               proglote.peso,
             ((prodloteope.longin*pdtojuego.alpaso)/pdtojuego.altura) AS cantidad,
               pdtoimpresion.idimpresion,
               pdtoimpresion.impresion,
               pdtodiseno.diseno,
               pdtoimpresion.anchof,
               pdtoimpresion.empalme,
               pdtojuego.registro,
               pdtojuego.alpaso,
               prodlote.cdglote
          FROM progbloque,
               proglote,
               prodlote,
               prodloteope,
               pdtodiseno, 
               pdtoimpresion,
               pdtojuego,
               pdtosustrato
        WHERE (pdtosustrato.cdgsustrato = progbloque.cdgsustrato AND
               progbloque.cdgbloque = proglote.cdgbloque AND
               proglote.cdglote = prodlote.cdglote AND
               prodlote.cdglote = prodloteope.cdglote AND 
               prodloteope.cdgoperacion = '10001') AND 
              (prodlote.cdgproducto = pdtoimpresion.cdgimpresion AND
               pdtoimpresion.cdgdiseno = pdtodiseno.cdgdiseno) AND
              (prodloteope.cdgjuego = pdtojuego.cdgjuego AND
               pdtojuego.cdgimpresion = pdtoimpresion.cdgimpresion) AND
              (prodlote.cdgproducto = '".$_GET['cdgproducto']."' AND
               prodlote.sttlote = 'A')");
    } else
    { // Etiquetas por producto y estatus
      $packingListSelect = $link->query("
        SELECT proglote.lote,
               proglote.tarima,
               proglote.idlote,
               prodlote.serie,
               prodlote.noop,
               prodlote.longitud,
               pdtosustrato.anchura,
               prodlote.peso,
             ((prodlote.longitud*pdtojuego.alpaso)/pdtojuego.altura) AS cantidad,
               pdtoimpresion.idimpresion,
               pdtoimpresion.impresion,
               pdtodiseno.diseno,
               pdtoimpresion.anchof,
               pdtoimpresion.empalme,
               pdtojuego.registro,
               pdtojuego.alpaso,
               prodlote.cdglote
          FROM progbloque,
               proglote,
               prodlote,           
               pdtodiseno,
               pdtoimpresion,
               pdtojuego,
               pdtosustrato
        WHERE (pdtosustrato.cdgsustrato = progbloque.cdgsustrato AND
               progbloque.cdgbloque = proglote.cdgbloque AND
               proglote.cdglote = prodlote.cdglote) AND 
              (prodlote.cdgproducto = pdtoimpresion.cdgimpresion AND
               pdtoimpresion.cdgdiseno = pdtodiseno.cdgdiseno AND
               pdtoimpresion.cdgimpresion = pdtojuego.cdgimpresion) AND
              (prodlote.cdgproducto = '".$_GET['cdgproducto']."' AND 
               prodlote.sttlote = '".$_GET['sttlote']."')"); 
    }
  }

  if ($packingListSelect->num_rows > 0)
  { $pdf=new FPDF('P','mm','lbl4x2'); 
    $pdf->SetDisplayMode(real, continuous);
    $pdf->AddFont('3of9','','free3of9.php');
    
    while ($regPackingList = $packingListSelect->fetch_object())
    { $pdf->AddPage();

      $pdf->SetY(9.5);
      $pdf->SetFont('Arial','',10);
      $pdf->Cell(2,4,'',0,0,'L');
      $pdf->Cell(48,4,'Producto',0,1,'L');
      $pdf->SetFont('Arial','B',12);
      $pdf->Cell(2,4,'',0,0,'L');
      $pdf->Cell(98,4,$regPackingList->impresion,0,1,'L');       
      $pdf->SetFont('Arial','',11);
      $pdf->Cell(2,4,'',0,0,'L');
      $pdf->Cell(98,4,$regPackingList->diseno,0,1,'L'); 
      $pdf->Ln(0.5);

      $pdf->SetFont('Arial','B',10);
      $pdf->Cell(2,4,'',0,0,'L');
      $pdf->Cell(18,4,utf8_decode('Informaci贸n'),0,1,'L');

      $pdf->SetFont('Arial','',10);
      $pdf->Cell(2,4,'',0,0,'L');
      $pdf->Cell(18,4,'Longitud',0,0,'L');
      $pdf->SetFont('Arial','B',10);
      $pdf->Cell(30,4,number_format($regPackingList->longitud,2).' mts',0,1,'R'); 

      $pdf->SetFont('Arial','',10);
      $pdf->Cell(2,4,'',0,0,'L');
      $pdf->Cell(18,4,'Ancho plano',0,0,'L');
      $pdf->SetFont('Arial','B',10);
      $pdf->Cell(30,4,$regPackingList->anchura.' mm',0,1,'R'); 

      $pdf->SetFont('Arial','',10);
      $pdf->Cell(2,4,'',0,0,'L');
      $pdf->Cell(18,4,'Peso',0,0,'L');
      $pdf->SetFont('Arial','B',10);
      $pdf->Cell(30,4,number_format($regPackingList->peso,3).' kgs',0,1,'R'); 

      $pdf->SetFont('Arial','',10);
      $pdf->Cell(2,4,'',0,0,'L'); 
      $pdf->Cell(28,4,'Piezas aprox',0,0,'L');
      $pdf->SetFont('Arial','B',10); 
      $pdf->Cell(20,4,number_format($regPackingList->cantidad*1000),0,1,'R'); 

      $pdf->SetY(-7);     
      $pdf->Cell(2,5,'',0,0,'L');      
      $pdf->SetFont('Arial','B',20);
      $pdf->Cell(68,5,'NoOP '.$regPackingList->noop,0,1,'R');

      // Informaci贸n
      $pdf->SetY(22);
      
      $pdf->SetFont('Arial','B',10); 
      $pdf->Cell(52,4,'',0,0,'L'); 
      $pdf->Cell(15,4,'Refilado',0,1,'L');
      
      $pdf->Cell(52,4,'',0,0,'L'); 
      $pdf->SetFont('Arial','',10); 
      $pdf->Cell(28,4,'Ancho plano',0,0,'L');
      $pdf->SetFont('Arial','B',12); 
      $pdf->Cell(18,4,(($regPackingList->anchof*2)+$regPackingList->empalme).' mm',0,1,'R');
      
      $pdf->Cell(52,4,'',0,0,'L'); 
      $pdf->SetFont('Arial','',10); 
      $pdf->Cell(28,4,'Bobinas',0,0,'L');
      $pdf->SetFont('Arial','B',12); 
      $pdf->Cell(18,4,$regPackingList->alpaso,0,1,'R');
       
      $pdf->SetFont('Arial','B',10); 
      $pdf->Cell(52,4,'',0,0,'L');
      $pdf->Cell(46,4,$regPackingList->tarima.'/'.$regPackingList->idlote,0,1,'C');
      $pdf->Cell(52,4,'',0,0,'L');
      $pdf->Cell(46,4,$regPackingList->serie.'.'.$regPackingList->lote,0,1,'C');
      
      // C贸digo de barras
      $pdf->SetY(4);
      $pdf->SetFont('3of9','',28);      
      $pdf->Cell(80,5,'',0,0,'R'); 
      $pdf->Cell(16,5,'*'.$regPackingList->cdglote.'*',0,1,'R');
      $pdf->Ln(1);
      $pdf->SetFont('Arial','',8); 
      $pdf->Cell(50,3,'',0,0,'R'); 
      $pdf->Cell(46,3,$regPackingList->cdglote,0,1,'C');      

      // Imagen LOGOTIPO
      if (file_exists('../../img_sistema/logo.jpg')==true) 
      { $pdf->Image('../../img_sistema/logo.jpg',2,2,30); }
    }

    $pdf->Output();
  } else
  { echo '<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" type="text/css" href="../../css/2014.css" media="screen" /> 
  </head>
  <body>
    <h1>No se encontraron conincidencias.</1>
  </body>
</html>'; }
?>
